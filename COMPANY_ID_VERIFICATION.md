# Company ID Fetching and Subscription Mapping Verification

## Overview

This document explains how companies are fetched using the company ID field and how subscriptions are properly mapped to companies in the RiftFuel subscription management system.

## Data Structure

### Companies Collection
Companies are stored in Firestore with the following structure:
```javascript
{
  id: "company_uuid",  // Document ID (auto-generated by Firestore)
  name: "Company Name",
  description: "Company description",
  industry: "Industry type",
  location: "City, Country",
  adminUserId: "admin_user_id",
  isActive: true,
  accessStatus: "active|suspended",
  // ... other fields
}
```

### Subscriptions Collection
Subscriptions reference companies using the `companyID` field:
```javascript
{
  id: "subscription_uuid",  // Document ID (auto-generated by Firestore)
  companyID: "company_uuid",  // References the company document ID
  planType: "basic|standard|premium",
  status: "active|expired|suspended|pending",
  monthlyFee: 60000,
  currency: "KES",
  // ... other fields
}
```

## Implementation Details

### 1. Company Fetching (`src/services/companyService.js`)

```javascript
export const getAllCompanies = async () => {
  try {
    const companiesRef = collection(db, COLLECTIONS.COMPANIES);
    const q = query(companiesRef, orderBy('name', 'asc'));
    const snapshot = await getDocs(q);
    
    return snapshot.docs.map(doc => ({
      id: doc.id,  // This is the company ID used for mapping
      ...doc.data()
    }));
  } catch (error) {
    // Fallback to demo data
    return await getDemoCompanies();
  }
};
```

**Key Points:**
- Companies are fetched with their Firestore document `id`
- The `id` field is used as the primary identifier for mapping
- Demo data fallback maintains the same structure

### 2. Subscription Fetching (`src/services/subscriptionManagementService.js`)

```javascript
export const getCompanySubscriptions = async () => {
  try {
    const subscriptionsRef = collection(db, 'subscriptions');
    const q = query(subscriptionsRef, orderBy('createdAt', 'desc'));
    const snapshot = await getDocs(q);
    
    return snapshot.docs.map(doc => ({
      id: doc.id,
      ...doc.data(),  // Includes companyID field
      // ... date conversions
    }));
  } catch (error) {
    // Fallback to demo data
    return await getDemoSubscriptions();
  }
};
```

**Key Points:**
- Subscriptions include the `companyID` field that references company document IDs
- Each subscription has its own document ID for updates
- Demo data maintains the same `companyID` reference structure

### 3. Company-Subscription Mapping (`src/components/admin/CompanyManagement.jsx`)

```javascript
const loadCompanies = async () => {
  const [companiesData, statsData, subscriptionsData] = await Promise.all([
    getAllCompanies(),        // Returns companies with id field
    getCompanyStats(),
    getCompanySubscriptions() // Returns subscriptions with companyID field
  ]);
  
  // Create subscription lookup map
  const subscriptionMap = {};
  subscriptionsData.forEach(sub => {
    if (sub.companyID) {
      subscriptionMap[sub.companyID] = sub;  // Map: company.id -> subscription
    }
  });
  setSubscriptions(subscriptionMap);
};
```

**Key Points:**
- Creates a lookup map where `company.id` maps to subscription data
- Uses `sub.companyID` as the key to match with `company.id`
- Validates that `companyID` exists before mapping

### 4. Subscription Lookup in Components

```javascript
// In CompanyList.jsx
const getSubscriptionStatus = (companyId) => {
  const subscription = subscriptions[companyId];  // Lookup using company.id
  // ... process subscription data
};

// In filtering logic
const subscription = subscriptions[company.id];  // Direct lookup
```

**Key Points:**
- Uses `company.id` to look up subscription in the map
- Direct O(1) lookup performance
- Handles cases where no subscription exists

## Demo Data Structure

### Demo Companies
```javascript
export const demoCompanies = [
  {
    id: 'company1',  // Company ID
    name: 'TechCorp Solutions',
    // ... other fields
  },
  {
    id: 'company2',  // Company ID
    name: 'LogiFlow Ltd',
    // ... other fields
  },
  // ...
];
```

### Demo Subscriptions
```javascript
export const demoSubscriptions = [
  {
    id: 'sub1',
    companyID: 'company1',  // References company1
    status: 'active',
    // ... other fields
  },
  {
    id: 'sub2',
    companyID: 'company2',  // References company2
    status: 'suspended',
    // ... other fields
  },
  // ...
];
```

## Verification and Debugging

### 1. Console Logging
The system includes comprehensive logging to verify the mapping:

```javascript
// In CompanyManagement.jsx
console.log('Companies loaded:', companiesData.map(c => ({ id: c.id, name: c.name })));
console.log('Subscriptions loaded:', subscriptionsData.map(s => ({ id: s.id, companyID: s.companyID, status: s.status })));
console.log('Subscription map created:', subscriptionMap);

// In CompanyList.jsx
console.log(`Looking up subscription for company ID: ${companyId}`, {
  found: !!subscription,
  subscription: subscription,
  allSubscriptions: Object.keys(subscriptions)
});
```

### 2. Data Validation Function
```javascript
export const validateCompanySubscriptionMapping = () => {
  // Checks for:
  // - Orphaned subscriptions (subscription without company)
  // - Companies without subscriptions
  // - Complete mapping verification
  
  return {
    isValid: orphanedSubscriptions.length === 0,
    orphanedSubscriptions,
    companiesWithoutSubscriptions,
    mapping
  };
};
```

### 3. Browser Console Verification
When the application loads, check the browser console for:

1. **Company Loading Log:**
   ```
   Companies loaded: [
     { id: "company1", name: "TechCorp Solutions" },
     { id: "company2", name: "LogiFlow Ltd" },
     // ...
   ]
   ```

2. **Subscription Loading Log:**
   ```
   Subscriptions loaded: [
     { id: "sub1", companyID: "company1", status: "active" },
     { id: "sub2", companyID: "company2", status: "suspended" },
     // ...
   ]
   ```

3. **Mapping Verification:**
   ```
   Subscription map created: {
     "company1": { id: "sub1", companyID: "company1", status: "active", ... },
     "company2": { id: "sub2", companyID: "company2", status: "suspended", ... },
     // ...
   }
   ```

4. **Data Validation Results:**
   ```
   === Company-Subscription Mapping Validation ===
   Company IDs: ["company1", "company2", "company3", "company4"]
   Subscription Company IDs: ["company1", "company2", "company3"]
   Orphaned subscriptions: []
   Companies without subscriptions: [{ id: "company4", name: "AgriTech Innovations" }]
   === End Validation ===
   ```

## Expected Behavior

### Correct Mapping
- **Company1 (TechCorp)** → **Subscription1 (Active, Premium)**
- **Company2 (LogiFlow)** → **Subscription2 (Suspended, Standard)**
- **Company3 (GreenEnergy)** → **Subscription3 (Expired, Standard)**
- **Company4 (AgriTech)** → **No Subscription** (intentional for testing)

### UI Display
- Companies with active subscriptions show green status badges
- Companies with suspended subscriptions show orange status badges
- Companies with expired subscriptions show red status badges
- Companies without subscriptions show gray "No Subscription" badges

## Troubleshooting

### Issue: Subscriptions not showing for companies
**Check:**
1. Console logs show correct company IDs and subscription companyIDs
2. Subscription map contains expected mappings
3. No errors in subscription fetching

### Issue: Wrong subscription data displayed
**Check:**
1. Company ID matches subscription companyID exactly
2. No duplicate company IDs in the data
3. Subscription lookup function receives correct company ID

### Issue: Demo data not working
**Check:**
1. Demo data structure matches expected format
2. Company IDs in demo companies match companyIDs in demo subscriptions
3. Validation function reports no orphaned subscriptions

## Security Considerations

- Company ID is the Firestore document ID (secure, auto-generated)
- Subscription companyID field enforces company-level data isolation
- Firestore security rules prevent cross-company data access
- Main Admin role required for subscription management access

This implementation ensures proper company identification and subscription mapping while maintaining data integrity and security.
